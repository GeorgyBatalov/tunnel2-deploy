# ===================================================================
# Tunnel2 Server - Production Environment
# ===================================================================
# IMPORTANT: This file contains PRODUCTION configuration
# Secrets are loaded from Vault at runtime
# ===================================================================

# ===== Vault Configuration =====
# Vault address (internal docker network)
Vault__Address=http://tunnel2_vault:8300

# Vault token (SET THIS FROM .env FILE AFTER VAULT INITIALIZATION)
# DO NOT hardcode production token here!
Vault__Token=${VAULT_ROOT_TOKEN}

# Vault path configuration
Vault__BasePath=tunnel/tunnel-server
Vault__MountPoint=secret

# ===== Proxy Entries Configuration =====
# List of ProxyEntry instances that clients can connect to
# Format: ProxyEntries__Entries__0=e1, ProxyEntries__Entries__1=e2, etc.
ProxyEntries__Entries__0=e1

# ===== Public Domain Configuration =====
# CRITICAL: This must match your wildcard DNS setup
# Format: https://{sessionId}-{proxyEntryId}.tunnel2.xtunnel.ru
TunnelServer__PublicDomainUri=https://tunnel2.xtunnel.ru

# ===== TLS Certificate Configuration =====
# TLS certificate for TunnelClient↔TunnelServer connections (Control Plane)
# Certificate data and password are loaded from Vault (priority) or appsettings.json
# Vault path: kv/tunnel/tunnel-server → TunnelClientTls.CertificateData (base64)
# Vault path: kv/tunnel/tunnel-server → TunnelClientTls.CertificatePassword
TunnelServer__AllowTls13=true

# ===== Database Configuration =====
# PostgreSQL connection string (docker network service name: postgres)
# Using existing postgres container (shared with Tunnel v1, Keycloak, TunnelApi)
# Password loaded from Vault (PostgreSQL/Password)
ConnectionStrings__PostgreSQL=Host=postgres;Port=5432;Database=tunnel2;Username=tunnel2_user

# ===== Redis Configuration =====
# Redis connection string (using tunnel2_redis container)
Redis__ConnectionString=tunnel2_redis:6379,abortConnect=false

# ===== RabbitMQ Configuration =====
# RabbitMQ configuration (using existing chefbot_rabbitmq container)
# Created vhost /tunnel2 with user tunnel2_rabbitmq
# Password loaded from Vault (RabbitMQ/Password)
Rabbit__HostName=chefbot_rabbitmq
Rabbit__Port=5672
Rabbit__UserName=tunnel2_rabbitmq
Rabbit__VirtualHost=/tunnel2

# ===== Security & Feature Flags =====
# CRITICAL: MUST be false or omitted in production!
# DevSessionId feature allows clients to specify custom session IDs (INSECURE!)
# TunnelServer__AllowDevSessionId=false  # NEVER set to true in production!
# TUNNEL_SERVER_IS_TEST_ENV=false         # NEVER set to true in production!

# ===== Performance Tuning =====
# Kestrel limits for high load (adjust based on expected traffic)
Kestrel__Limits__MaxConcurrentConnections=5000
Kestrel__Limits__MaxConcurrentUpgradedConnections=5000
Kestrel__Limits__KeepAliveTimeout=00:02:00
Kestrel__Limits__RequestHeadersTimeout=00:00:30

# ===== Logging Configuration =====
# Serilog minimum level (Information for production, Debug for troubleshooting)
Serilog__MinimumLevel__Default=Information
Serilog__MinimumLevel__Override__Microsoft=Warning
Serilog__MinimumLevel__Override__System=Warning

# ===== ASP.NET Core Environment =====
ASPNETCORE_ENVIRONMENT=Production

# ===== OpenTelemetry / Distributed Tracing (Phase 8) =====
# Loaded from Vault (OpenTelemetry/Enabled, OpenTelemetry/OtlpEndpoint)
