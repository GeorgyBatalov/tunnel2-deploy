groups:
  - name: tunnel2-server-health
    interval: 15s
    rules:
      # Alert: Service is down (no active scrapes from tunnel_server)
      - alert: Tunnel2ServerDown
        expr: up{job="tunnel2-server"} == 0
        for: 1m
        labels:
          severity: critical
          service: tunnel2-server
        annotations:
          summary: "Tunnel2 Server is down"
          description: "Tunnel2 Server ({{ $labels.instance }}) has been unreachable for more than 1 minute."

      # Alert: High scrape duration (health check degradation)
      - alert: Tunnel2ServerSlowScrape
        expr: scrape_duration_seconds{job="tunnel2-server"} > 1
        for: 2m
        labels:
          severity: warning
          service: tunnel2-server
        annotations:
          summary: "Tunnel2 Server scrape is slow"
          description: "Tunnel2 Server ({{ $labels.instance }}) scrape duration is {{ $value }}s (threshold: 1s)."

  - name: tunnel2-quota-limits
    interval: 15s
    rules:
      # Alert: High quota denial rate
      - alert: HighQuotaDenialRate
        expr: sum(rate(session_quota_denied_total[1m])) > 5
        for: 2m
        labels:
          severity: warning
          service: tunnel2-server
        annotations:
          summary: "High quota denial rate detected"
          description: "Quota denials are happening at {{ $value | humanize }} requests/sec (threshold: 5 req/s). Check quota limits and client tier distribution."

      # Alert: Critical quota denial rate
      - alert: CriticalQuotaDenialRate
        expr: sum(rate(session_quota_denied_total[1m])) > 20
        for: 1m
        labels:
          severity: critical
          service: tunnel2-server
        annotations:
          summary: "CRITICAL: Very high quota denial rate"
          description: "Quota denials are happening at {{ $value | humanize }} requests/sec (threshold: 20 req/s). Immediate action required!"

      # Alert: Quota usage near limit
      - alert: QuotaUsageHigh
        expr: quota_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: tunnel2-server
        annotations:
          summary: "Quota usage is high"
          description: "Client {{ $labels.hardware_id }} (tier: {{ $labels.tier }}) has {{ $value }}% quota usage for {{ $labels.quota_type }}."

  - name: tunnel2-session-health
    interval: 15s
    rules:
      # Alert: High session close rate (potential issues)
      - alert: HighSessionCloseRate
        expr: sum(rate(session_closed_total{close_reason!~"UplinkClosed|Normal"}[1m])) > 2
        for: 3m
        labels:
          severity: warning
          service: tunnel2-server
        annotations:
          summary: "High abnormal session close rate"
          description: "Sessions are closing abnormally at {{ $value | humanize }} sessions/sec. Check close reasons and server health."

      # Alert: No active sessions for extended period (possible connectivity issue)
      - alert: NoActiveSessions
        expr: sum(tunnels_active_total) == 0
        for: 10m
        labels:
          severity: info
          service: tunnel2-server
        annotations:
          summary: "No active tunnel sessions"
          description: "No active tunnel sessions detected for 10 minutes. This may be expected during low traffic periods."

      # Alert: Very high number of active sessions (capacity check)
      - alert: HighActiveSessionCount
        expr: sum(tunnels_active_total) > 100
        for: 5m
        labels:
          severity: warning
          service: tunnel2-server
        annotations:
          summary: "High number of active sessions"
          description: "{{ $value }} active tunnel sessions detected. Monitor server resources (CPU, memory, network)."

  - name: tunnel2-dependencies
    interval: 30s
    rules:
      # Alert: Redis connection issues
      - alert: RedisConnectionFailed
        expr: redis_operations_total{status="error"} > 0
        for: 2m
        labels:
          severity: critical
          service: tunnel2-server
        annotations:
          summary: "Redis connection errors detected"
          description: "Redis operations are failing. Check Redis connectivity and health."

      # Alert: RabbitMQ publishing issues
      - alert: RabbitMQPublishingFailed
        expr: rabbitmq_messages_published_total{status="error"} > 0
        for: 2m
        labels:
          severity: critical
          service: tunnel2-server
        annotations:
          summary: "RabbitMQ publishing errors detected"
          description: "RabbitMQ message publishing is failing. Check RabbitMQ connectivity and health."
